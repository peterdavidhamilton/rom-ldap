#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# Too many open files - getcwd (Errno::EMFILE)
# increase file limit
ulimit -n 1024


brew install docker-machine

docker-machine create -d virtualbox default

eval $(docker-machine env)

docker kill ldap

docker rm ldap

# https://github.com/greggigon/apacheds
docker run \
--name ldap \
-p 10389:10389 \
-d greggigon/apacheds:latest

export LDAPHOST=$(docker-machine ip)
export LDAPPORT=389


# create apacheds password file
echo -n secret > ./ldappw

# restrict file access
chmod 700 ldappw

# read from ldap server
ldapsearch -x -y ldappw +

# prepare specs
bundle install

# prepare examples
cd example
ruby-install ruby 2.3
chruby 2.3
gem install bundle
bundle install
# bundle exec ruby ./life.rb


# prepare benchmarks
cd ../benchmark
bundle install
