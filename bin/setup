#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# Too many open files - getcwd (Errno::EMFILE)
# increase file limit
ulimit -n 1024



if [[ `which docker-machine` ]]; then
  # Create LDAP container
  # https://github.com/openmicroscopy/apacheds-docker
  docker run --name rom-ldap -d -p 389:10389 -e APACHEDS_INSTANCE=rom -v $(pwd)/example/ldif/config.ldif:/bootstrap/conf/config.ldif:ro openmicroscopy/apacheds
else
  # Setup Docker
  brew install docker-machine
  docker-machine create -d virtualbox default
  eval $(docker-machine env)
fi




export LDAPHOST=$(docker-machine ip)
export LDAPPORT=389

# create apacheds password file
echo -n secret > ./ldappw
chmod 700 ./ldappw

# read from ldap server
ldapsearch -x -y ldappw + \*


if [[ `chruby | grep ruby-2.3` ]]; then
  gem install bundle
  bundle install
else
  ruby-install ruby 2.3
  chruby 2.3
fi





# # prepare specs
# bundle install
# # prepare examples
# cd example
# # prepare benchmarks
# cd ../benchmark
# bundle install
