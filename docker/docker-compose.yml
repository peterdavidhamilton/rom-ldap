version: '2.4'
networks:
  rom-ldap-network:

services:
  rom:
    container_name: rom-ldap
    build:
      context: ..
      dockerfile: docker/rom-ldap/Dockerfile
      labels:
        name: ROM LDAP Adapter
    environment:
      - LDAPHOST=apacheds
      - LDAPPORT=10389
      - LDAPBASE=dc=rom,dc=ldap
      - LDAPBINDDN=uid=admin,ou=system
      - LDAPBINDPW=secret
      - LDAPDIR=/src/docker/schema
      - GITLAB_TOKEN
      - AD_URI
      - AD_USER
      - AD_PW
      #- TZ=America/Los_Angeles
    restart: on-failure
    depends_on:
      - 389ds
      - apacheds
      - opendj
      - openldap
    volumes:
      - ..:/src
    tty: true
    stdin_open: true
    networks:
      - rom-ldap-network



  # 1 ubuntu
  # docker build -t apacheds .
  # docker run -it -p 1389:10389 -e APACHEDS_INSTANCE=rom apacheds
  # ou=schema
  #
  apacheds:
    container_name: apacheds
    build:
      context: ./apacheds
      labels:
        vendor: Apache
      args:
        # version: 2.0.0.AM25
        version: 2.0.0-M24
        # repo: archive.apache.org
        architecture: amd64
    tty: true
    stdin_open: true
    ports:
      - 1389:10389
      - 1636:10636
    volumes:
      - ../tmp/apacheds:/var/lib/apacheds
    hostname: rom.ldap
    restart: on-failure
    healthcheck:
      test: curl ldap://127.0.0.1:10389/dc=rom,dc=ldap || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 1
    # environment:
    #   APACHEDS_INSTANCE: rom
    #   TZ: America/Los_Angeles
    networks:
      - rom-ldap-network



  # 2 debian
  # docker build -t openldap .
  # docker run -it -p 2389:389 -e LDAP_DOMAIN=rom.ldap -e LDAP_BASE_DN=dc=rom,dc=ldap openldap
  #
  openldap:
    container_name: openldap
    build:
      context: ./openldap
      labels:
        vendor: OpenLDAP
    tty: true
    stdin_open: true
    volumes:
      # - ../tmp/openldap:/var/lib/ldap
      # - ../tmp/openldap:/etc/ldap/slapd.d
      - ../tmp/openldap:/var/log
    ports:
      - 2389:389
      - 2636:636
    hostname: rom.ldap
    restart: on-failure
    healthcheck:
      test: curl ldap://127.0.0.1:389/dc=rom,dc=ldap || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 1
    environment:
      # LDAP_LOG_LEVEL: 256
      LDAP_ORGANISATION: ROM-LDAP OpenLDAP Server
      LDAP_DOMAIN: rom.ldap
      LDAP_BASE_DN: dc=rom,dc=ldap
      LDAP_ADMIN_PASSWORD: topsecret
      # TZ: America/Los_Angeles
    networks:
      - rom-ldap-network



  # 3 centos
  # cd ./389ds && docker build -t 389ds .
  # docker run -it -p 3389:389 -e DIRSRV_FQDN=rom.ldap -e DIRSRV_SUFFIX=dc=rom,dc=ldap 389
  # cn=schema
  #
  389ds:
    container_name: 389ds
    build:
      context: ./389ds
      labels:
        vendor: 389ds
    tty: true
    stdin_open: true
    ports:
      - 3389:389
      - 3636:636
      # - 9830:9830
    volumes:
      # - ../tmp/389ds:/etc/dirsrv
      # - ../tmp/389ds:/var/lib/dirsrv
      - ../tmp/389ds:/var/log/dirsrv
    hostname: rom.ldap
    restart: on-failure
    healthcheck:
      test: "curl -u 'cn=Directory Manager:topsecret' ldap://127.0.0.1:389/dc=rom,dc=ldap || exit 1"
      interval: 30s
      timeout: 10s
      retries: 1
    environment:
      LDAP_LOG_LEVEL: 0
      DIRSRV_ID: rom
      DIRSRV_FQDN: rom.ldap
      DIRSRV_SUFFIX: dc=rom,dc=ldap
      DIRSRV_ROOT_DN: cn=Directory Manager
      DIRSRV_ROOT_DN_PASSWORD: topsecret
      # DIRSRV_ADMIN_USERNAME: admin
      # DIRSRV_ADMIN_PASSWORD: adminpassword
      # TZ: America/Los_Angeles
    networks:
      - rom-ldap-network




  # 4 debian
  # docker build -t opendj .
  # docker run -it -p 4389:389 -e BASE_DN=dc=rom,dc=ldap opendj
  #
  opendj:
    container_name: opendj
    build:
      context: ./opendj
      args:
        version: 4.3.1
      labels:
        vendor: OpenIdentity
    tty: true
    stdin_open: true
    ports:
      - 4389:389
      - 4636:636
      # - 4444:4444
    # volumes:
    #   - ../tmp/opendj:/opt/opendj
    #   - ../tmp/opendj:/var/log:rw
    hostname: rom.ldap
    restart: on-failure
    healthcheck:
      test: curl ldap://127.0.0.1:389/dc=rom,dc=ldap || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 1
    environment:
      BASE_DN: dc=rom,dc=ldap
      ROOT_USER_DN: cn=Directory Manager
      ROOT_PASSWORD: topsecret
      # TZ: America/Los_Angeles
    networks:
      - rom-ldap-network
